//
//  ui_controller.c
//  earthnews
//
//  Created by Ubaka Onyechi on 27/12/2012.
//  Copyright (c) 2012 uonyechi.com. All rights reserved.
//

#include "ui_ctrlr.h"
#include "browser.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

enum e_uid
{
  UI_ID_TWITTER_VIEW,
  UI_ID_TWITTER_SHUFFLE_BUTTON,
  UI_ID_NEWS_BUTTON
};

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static ui_context_t *s_uicontext = NULL;
//static ui_button_t  *s_uibutton = NULL;

#define NEWS_MAX_ENTRIES 7

typedef struct ui_news_t
{
  cx_font *font;
  ui_custom_t *buttons [NEWS_MAX_ENTRIES];
  float opacity;
} ui_news_t;

static ui_news_t s_uinews;

#define TWITTER_MAX_ENTRIES 15

typedef struct ui_twitter_t 
{
  cx_font *font1, *font2;
  ui_custom_t *view;
  cx_texture *avatars [TWITTER_MAX_ENTRIES];
  ui_button_t *shuffle;
  float opacity;
} ui_twitter_t;

static ui_twitter_t s_uitwitter;

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_init_create_widgets (void);
static void ui_ctrlr_deinit_destroy_widgets (void);

static void ui_ctrlr_news_create (void);
static void ui_ctrlr_news_button_pressed (const ui_custom_t *custom);
static void ui_ctrlr_news_button_render (const ui_custom_t *custom);
static void ui_ctrlr_news_populate (news_feed_t *feed);

static void ui_ctrlr_twitter_create (void);
static void ui_ctrlr_twitter_button_pressed (const ui_button_t *button);
static void ui_ctrlr_twitter_render (const ui_custom_t *custom);
static void ui_ctrlr_twitter_populate (twitter_feed_t *feed);

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void ui_ctrlr_init (float width, float height)
{
  s_uicontext = ui_init (width, height);
  
  ui_ctrlr_init_create_widgets ();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void ui_ctrlr_deinit (void)
{
  ui_ctrlr_deinit_destroy_widgets ();
  
  ui_deinit (s_uicontext);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void ui_ctrlr_render (void)
{
  ui_render (s_uicontext);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void ui_ctrlr_screen_resize (float width, float height)
{
  ui_canvas_resize (s_uicontext, width, height);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool ui_ctrlr_handle_input (const input_touch_event *event)
{
  return ui_input (s_uicontext, event);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void ui_ctrlr_set_news_feed_visible (bool visible)
{
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void ui_ctrlr_set_news_feed (news_feed_t *feed)
{
  CX_ASSERT (feed);
  
  ui_ctrlr_news_populate (feed);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void ui_ctrlr_set_news_feed_opacity (float opacity)
{
  s_uinews.opacity = opacity;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_init_create_widgets (void)
{
#if 0
  s_uibutton = ui_button_create (s_uicontext, -1);
  s_uibutton->text = "button-1";
  s_uibutton->intr.colour [UI_WIDGET_STATE_NORMAL] = *cx_colour_red ();
  s_uibutton->intr.colour [UI_WIDGET_STATE_HOVER] = *cx_colour_green ();
  s_uibutton->intr.colour [UI_WIDGET_STATE_FOCUS] = *cx_colour_blue ();
  cx_vec2_set (&s_uibutton->intr.position, 0.0f, 0.0f);
  cx_vec2_set (&s_uibutton->intr.dimension, 200.0f, 40.0f);
#endif
  
  ui_ctrlr_news_create ();  
  ui_ctrlr_twitter_create ();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_deinit_destroy_widgets (void)
{
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_news_create (void)
{
  const float height = 180.0f;
  const float posX = 12.0f;
  const float posY = 582.0f;
  const float itemSpacingY = height / (float) NEWS_MAX_ENTRIES;
  
  ui_custom_callbacks_t newsCallbacks;
  memset (&newsCallbacks, 0, sizeof (ui_custom_callbacks_t));
  newsCallbacks.pressFn = ui_ctrlr_news_button_pressed;
  newsCallbacks.renderFn = ui_ctrlr_news_button_render;
  
  float x = posX;
  float y = posY;
  
  for (int i = 0; i < NEWS_MAX_ENTRIES; ++i)
  {
    ui_custom_t *custom = ui_custom_create (s_uicontext, UI_ID_NEWS_BUTTON + i);
    ui_custom_set_callbacks (custom, &newsCallbacks);
    
    ui_widget_set_position (custom, x, y);
    ui_widget_set_colour (custom, UI_WIDGET_STATE_NORMAL, cx_colour_white ());
    ui_widget_set_colour (custom, UI_WIDGET_STATE_HOVER, cx_colour_grey ());
    ui_widget_set_colour (custom, UI_WIDGET_STATE_FOCUS, cx_colour_blue ());
    
    s_uinews.buttons [i] = custom;
    
    y += itemSpacingY;
  }
  
  s_uinews.opacity = 1.0f;
  s_uinews.font = cx_font_create ("data/fonts/verdana.ttf", 14);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_news_populate (news_feed_t *feed)
{
  CX_ASSERT (feed);
  
  if (feed->dataReady)
  {
    int count = NEWS_MAX_ENTRIES - 1;
    
    ui_custom_t **buttons = s_uinews.buttons;
    
    news_feed_item_t *entry = feed->items;
    
    cx_font *font = s_uinews.font;
    
    float fh = cx_font_get_height (font);
    
    int i = 0;
    
    while (entry && count--)
    {
      float fw = cx_font_get_text_width (font, entry->title);
      
      ui_custom_t *custom = buttons [i++];
      
      custom->userdata = entry;
      custom->intr.dimension.x = fw;
      custom->intr.dimension.y = fh;
      
      entry = entry->next;
    }
    
    const char *morenews = "More news...";
    ui_custom_t *custom = buttons [i];
    
    custom->userdata = feed->link;
    custom->intr.dimension.x = cx_font_get_text_width (font, morenews);
    custom->intr.dimension.y = fh;
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_news_button_render (const ui_custom_t *custom)
{
  const char *title = NULL;
  
  ui_custom_t *moreNewsButton = s_uinews.buttons [NEWS_MAX_ENTRIES - 1];
  
  if (moreNewsButton == custom)
  {
    title = custom->userdata ? "More news..." : NULL;
  }
  else
  {
    news_feed_item_t *entry = (news_feed_item_t *) custom->userdata;
    
    title = entry ? entry->title : NULL;
  }

  cx_font *font = s_uinews.font;
  CX_ASSERT (font);
  
  float opacity = s_uinews.opacity;
  float x1 = custom->intr.position.x;
  float y1 = custom->intr.position.y;

  ui_widget_state_t wstate = ui_widget_get_state (s_uicontext, custom);
  cx_colour colour = custom->intr.colour [wstate];
  colour.a *= opacity;
  
#if 1
  float x2 = x1 + custom->intr.dimension.x;
  float y2 = y1 + custom->intr.dimension.y;
  
  cx_colour colours [3];    
  cx_colour_set (&colours [0], 1.0f, 0.0f, 0.0f, 0.45f);
  cx_colour_set (&colours [1], 0.0f, 1.0f, 0.0f, 0.45f);
  cx_colour_set (&colours [2], 0.0f, 0.0f, 1.0f, 0.45f);
  
  int uid = custom->intr.uid;
  cx_draw_quad (x1, y1, x2, y2, 0.0f, 0.0f, &colours [uid % 3], NULL);
#endif
  
  if (title)
  {
    cx_font_render (font, title, x1, y1, 0.0f, CX_FONT_ALIGNMENT_DEFAULT, &colour);
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_news_button_pressed (const ui_custom_t *custom)
{
  CX_ASSERT (custom);
  
  const char *link = NULL, *title = NULL;
  
  ui_custom_t *moreNewsButton = s_uinews.buttons [NEWS_MAX_ENTRIES - 1];
  
  if (moreNewsButton == custom)
  {
    title = "More news...";
    link = (const char *) custom->userdata;
  }
  else
  {
    news_feed_item_t *entry = (news_feed_item_t *) custom->userdata;
    
    title = entry ? entry->title : NULL;
    link = entry ? entry->link : NULL;
  }

  
  if (link && title)
  {
    bool open = browser_open (link, title);
    CX_REFERENCE_UNUSED_VARIABLE (open);
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_twitter_create (void)
{
#if 0
  const float height = 180.0f;
  const float posX = 12.0f;
  const float posY = 582.0f;
  const float itemSpacingY = height / (float) NEWS_MAX_ENTRIES;
  
  ui_custom_callbacks_t newsCallbacks;
  newsCallbacks.pressFn = ui_ctrlr_news_button_pressed;
  newsCallbacks.renderFn = ui_ctrlr_news_button_render;
  
  float x = posX;
  float y = posY;
  
  for (int i = 0; i < NEWS_MAX_ENTRIES; ++i)
  {
    ui_custom_t *custom = ui_custom_create (s_uicontext, UI_ID_NEWS_BUTTON + i);
    ui_custom_set_callbacks (custom, &newsCallbacks);
    
    ui_widget_set_position (custom, x, y);
    ui_widget_set_colour (custom, UI_WIDGET_STATE_NORMAL, cx_colour_white ());
    ui_widget_set_colour (custom, UI_WIDGET_STATE_HOVER, cx_colour_grey ());
    ui_widget_set_colour (custom, UI_WIDGET_STATE_FOCUS, cx_colour_blue ());
    
    s_uinews.buttons [i] = custom;
    
    y += itemSpacingY;
  }
  
#endif
  
  s_uitwitter.opacity = 1.0f;
  //s_uitwitter.font0 = cx_font_create ("data/fonts/verdana.ttf", 14);
  
  
  ui_custom_callbacks_t twitterCallbacks;  
  memset (&twitterCallbacks, 0, sizeof (ui_custom_callbacks_t));
  twitterCallbacks.renderFn = ui_ctrlr_twitter_render;
  
  ui_button_callbacks_t twbuttonCallbacks;
  memset (&twbuttonCallbacks, 0, sizeof (ui_button_callbacks_t));
  twbuttonCallbacks.pressFn = ui_ctrlr_twitter_button_pressed;

#if 0
  s_uitwitter.view = ui_custom_create (s_uicontext, UI_ID_TWITTER_VIEW);
  s_uitwitter.shuffle = ui_button_create (s_uicontext, UI_ID_TWITTER_SHUFFLE_BUTTON);
  
  ui_widget_set_colour (s_uitwitter.view, UI_WIDGET_STATE_NORMAL, cx_colour_red ());
  ui_widget_set_position (s_uitwitter.view, 0.0f, 0.0f);
  
  ui_custom_set_callbacks (s_uitwitter.view, &twitterCallbacks);
#endif
}

void ui_ctrlr_set_twitter_feed (twitter_feed_t *feed)
{
  CX_ASSERT (feed);
  ui_ctrlr_twitter_populate (feed);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_twitter_button_pressed (const ui_button_t *button)
{
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_twitter_render (const ui_custom_t *custom)
{
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void ui_ctrlr_twitter_populate (twitter_feed_t *feed)
{
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
