//
//  webview.m
//  earthnews
//
//  Created by Ubaka Onyechi on 30/03/2013.
//  Copyright (c) 2013 uonyechi.com. All rights reserved.
//

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

#import "webview.h"
#import <UIKit/UIKit.h>

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

#define WEBVIEW_DEBUG_LOG_ENABLED 1


////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

@interface WebViewController : UIViewController <UIWebViewDelegate>
{
  UIWebView *_webView;
}
@end

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool webview_init (const void *rootvc);

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool webview_deinit (void);

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool webview_show (const char *url, const char *title);

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool webview_hide (void);

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

@implementation WebViewController

- (id) init
{
  self = [super init];
  
  if (self)
  {
    _webView = nil;
  }
  
  return self;
}

- (void) dealloc
{
  [_webView release];
  
  [super dealloc];
}

- (void)viewWillAppear:(BOOL)animated
{
  [self setView:_webView];
}

- (void)viewDidAppear:(BOOL)animated
{
  [self setView:nil];
  
  [_webView release];
  
  _webView = nil;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType
{
  switch (navigationType)
  {
    case UIWebViewNavigationTypeLinkClicked:
    {
      CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED, "Webview: navigationType: UIWebViewNavigationTypeLinkClicked)");
      //[webView stringByEvaluatingJavaScriptFromString:@"document.body.innerHTML = \"\";"];
      //[webView loadRequest:request];
      break;
    }
    case UIWebViewNavigationTypeFormSubmitted:
    {
      CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED, "Webview: navigationType: UIWebViewNavigationTypeFormSubmitted)");
      break;
    }
    case UIWebViewNavigationTypeBackForward:
    {
      CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED, "Webview: navigationType: UIWebViewNavigationTypeBackForward)");
      break;
    }
    case UIWebViewNavigationTypeReload:
    {
      CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED, "Webview: navigationType: UIWebViewNavigationTypeReload)");
      break;
    }
    case UIWebViewNavigationTypeFormResubmitted:
    {
      CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED, "Webview: navigationType: UIWebViewNavigationTypeFormResubmitted)");
      break;
    }
    case UIWebViewNavigationTypeOther:
    {
      CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED, "Webview: navigationType: UIWebViewNavigationTypeOther)");
      break;
    }
    default:
    {
      CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED, "Webview: navigationType: Unknown!)");
      break;
    }
  }
  
#if WEBVIEW_DEBUG_LOG_ENABLED
  NSString *hostname = [[request URL] host];
  NSLog (@"Webview: Hostname: %@", hostname);
  NSLog (@"Webview: request: %@", request);
#endif
  
  if ([request isKindOfClass:[NSMutableURLRequest class]])
  {
    NSMutableURLRequest *mutableRequest = (NSMutableURLRequest *) request;
    [mutableRequest setCachePolicy:NSURLRequestReturnCacheDataElseLoad];
  }
  
  return YES;
}
//
- (void) webViewDidStartLoad:(UIWebView *)webView
{
  CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED && 1, "Webview: Starting load");
  //[[UIApplication sharedApplication] setNetworkActivityIndicatorVisible:YES];
}
//
- (void) webViewDidFinishLoad:(UIWebView *)webView
{
  NSString *docTitle = [webView stringByEvaluatingJavaScriptFromString:@"document.title"];
  
  if (docTitle.length > 0)
  {
  }
  
  CX_DEBUGLOG_CONSOLE (WEBVIEW_DEBUG_LOG_ENABLED && 1, "Webview: Finishing load");
}
//
- (void) webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error
{
#if WEBVIEW_DEBUG_LOG_ENABLED
  NSLog (@"Webview: Error: [%d] %@", [error code], [error description]);
#endif
}

@end

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
