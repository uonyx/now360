//
//  webview.m
//  earthnews
//
//  Created by Ubaka Onyechi on 30/03/2013.
//  Copyright (c) 2013 uonyechi.com. All rights reserved.
//

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

#import "webview.h"
#import "util.h"
#import "SVModalWebViewController.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

#define WEBVIEW_DEBUG_LOG_ENABLED       1
#define WEBVIEW_UI_SIZE_WIDTH          (778.0f)
#define WEBVIEW_UI_SIZE_HEIGHT         (620.0f)
#define WEBVIEW_SCREEN_FADE_OPACITY    (0.6f)
#define WEBVIEW_SCREEN_FADE_DURATION   (0.5f)

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

@interface WebViewControllerDelegate : NSObject<SVModalWebViewControllerDelegate>
@end

#if 0
@interface PopOverControllerDelegate : NSObject<UIPopoverControllerDelegate>
@end
#endif

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static bool s_initialised = false;
static bool s_active = false;
static UIViewController *s_rootViewCtrlr = nil;
static UIPopoverController *s_popover = nil;
static SVModalWebViewController *s_webViewCtrlr = nil;
static WebViewControllerDelegate *s_webViewDelegate = nil;

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool webview_init (const void *rootvc)
{
  CX_ASSERT (!s_initialised);
  CX_ASSERT (rootvc);
  
  s_rootViewCtrlr = (UIViewController *) rootvc;
  
  s_webViewDelegate = [[WebViewControllerDelegate alloc] init];
  
  s_webViewCtrlr = [[SVModalWebViewController alloc] initWithAddress:@""];
  
  s_popover = [[UIPopoverController alloc] initWithContentViewController:s_webViewCtrlr];
  
  return s_initialised;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void webview_deinit (void)
{
  CX_ASSERT (s_initialised);
  
  [s_popover release];
  
  [s_webViewCtrlr release];
  
  s_rootViewCtrlr = nil;
  
  s_initialised = false;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void webview_show (const char *url, const char *title)
{
  if (!s_active)
  {
    UIView *parentView = s_rootViewCtrlr.view;

    float viewPosX = parentView.bounds.origin.x;
    float viewPosY = parentView.bounds.origin.y;
    float viewWidth  = parentView.bounds.size.width;
    float viewHeight = parentView.bounds.size.height;

    float width = WEBVIEW_UI_SIZE_WIDTH;
    float height = WEBVIEW_UI_SIZE_HEIGHT;
    float posX = viewPosX + ((viewWidth - width) * 0.5f);
    float posY = viewPosY + ((viewHeight - height) * 0.5f);

    if (s_webViewCtrlr)
    {
      [s_webViewCtrlr release];
      s_webViewCtrlr = nil;
    }

    NSString *objcURL = [NSString stringWithCString:url encoding:NSASCIIStringEncoding];
    NSString *objcTitle = title ? [NSString stringWithCString:title encoding:NSASCIIStringEncoding] : nil;
    
    s_webViewCtrlr = [[SVModalWebViewController alloc] initWithAddress:objcURL title:objcTitle];
    [s_webViewCtrlr setSvdelegate:s_webViewDelegate];
    [s_webViewCtrlr setContentSizeForViewInPopover:CGSizeMake (width, height)];
    [s_webViewCtrlr setAvailableActions:(SVWebViewControllerAvailableActionsOpenInSafari |
                                         SVWebViewControllerAvailableActionsCopyLink |
                                         SVWebViewControllerAvailableActionsMailLink)];

    [s_popover setContentViewController:s_webViewCtrlr];
    [s_popover setPopoverContentSize:CGSizeMake(width, height)];
    [s_popover setPassthroughViews:[NSArray arrayWithObject:parentView]];
    [s_popover presentPopoverFromRect:CGRectMake(posX, posY, width, height) inView:parentView permittedArrowDirections:0 animated:YES];

    util_screen_fade_trigger (SCREEN_FADE_TYPE_OUT, WEBVIEW_SCREEN_FADE_OPACITY, WEBVIEW_SCREEN_FADE_DURATION, NULL, NULL);
    
    s_active = true;
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
    
void webview_hide (void)
{
  if (s_active)
  {
    [s_popover dismissPopoverAnimated:YES];
    
    util_screen_fade_trigger (SCREEN_FADE_TYPE_IN, WEBVIEW_SCREEN_FADE_OPACITY, WEBVIEW_SCREEN_FADE_DURATION, NULL, NULL);
    
    s_active = false;
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool webview_active (void)
{
  return s_active;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

@implementation WebViewControllerDelegate

- (void) doneButtonClicked:(SVModalWebViewController *)webViewController
{
  webview_hide ();
}

@end

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
#if 0
@implementation PopOverControllerDelegate

- (void)popoverControllerDidDismissPopover:(UIPopoverController *)popoverController
{
  if (s_webViewCtrlr)
  {
    [s_webViewCtrlr release];
    s_webViewCtrlr = nil;
  }
}

@end
#endif
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
