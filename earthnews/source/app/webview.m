//
//  webview.m
//  earthnews
//
//  Created by Ubaka Onyechi on 08/07/2012.
//  Copyright (c) 2012 uonyechi.com. All rights reserved.
//

#import "webview.h"
#import <UIKit/UIKit.h>
#import "../engine/cx_engine.h"
#import "../ios/AppDelegate.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

@interface ToolBarNotification : NSObject
{
}

- (void) handleRefresh;
//- (void) handleForward;
//- (void) handleBack;

@end

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

UIWebView *g_uiwebview = nil;
static ToolBarNotification *s_toolbarNotification = nil;
bool g_isAnimating = false;

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

@implementation ToolBarNotification

- (void) handleRefresh
{
}

@end

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool web_view_init (float screenWidth, float screenHeight)
{
  bool success = false;
  
#if 0
  CGRect mainScreenRect = [[UIScreen mainScreen] bounds];
  screenWidth = mainScreenRect.size.width;
  screenHeight = mainScreenRect.size.height;
#else
  screenWidth = 1024.0f;
  screenHeight = 768.0f;
#endif
  
  float w = 778.0f;
  float h = 620.0f;
  
  float x = 0.0f + ((screenWidth - w) * 0.5f);
  float y = 0.0f + ((screenHeight - h) * 0.5f);
  
  g_uiwebview = [[UIWebView alloc] initWithFrame:CGRectMake (x, y, w, h)];
  
#if 1
  AppDelegate* myDelegate = (((AppDelegate*) [UIApplication sharedApplication].delegate));
  UIViewController *rootViewController = [myDelegate.window rootViewController];
#else
  UIViewController *rootViewController = [[[UIApplication sharedApplication] keyWindow] rootViewController];
#endif
  
  //[g_uiwebview loadRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:@"http://uonyechi.com"]]];
  [[rootViewController view] addSubview:g_uiwebview];
  
  [g_uiwebview setScalesPageToFit:YES];
  //[g_uiwebview setHidden:YES];
  //[g_uiwebview setAlpha:0.0f];
  
  
  s_toolbarNotification = [[ToolBarNotification alloc] init];
  
  //UIToolbar *toolbar = [[UIToolbar alloc] initWithFrame:CGRectMake(x, y, w, 50.0f)];
  UIToolbar *toolbar = [[UIToolbar alloc] initWithFrame:CGRectMake(0.0f, 0.0f, w, 50.0f)];
  [toolbar setBarStyle:UIBarStyleDefault];
  [toolbar sizeToFit];
  
  UIBarButtonItem *buttonItem1 = [[UIBarButtonItem alloc] initWithBarButtonSystemItem:UIBarButtonSystemItemRefresh target:s_toolbarNotification action:@selector(handleRefresh)];
  
  
  NSMutableArray *array = [[NSMutableArray alloc] init];
  
  [array addObject:buttonItem1];
  
  [toolbar setItems:array animated:YES];
  
  [g_uiwebview addSubview:toolbar];
  
  web_view_launch_url ("");
  
  return success;
}


////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool web_view_deinit (void)
{
  bool success = false;
  
  return success;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool web_view_launch_url (const char *url)
{
  CX_ASSERT (url);
  //CX_ASSERT (url && *url);
  
  bool success = false;
  
  CX_ASSERT (g_uiwebview);
  
  [g_uiwebview stopLoading];
  [g_uiwebview loadRequest:[NSURLRequest requestWithURL:[NSURL URLWithString:[NSString stringWithCString:url encoding:NSASCIIStringEncoding]]]];
  
  /*
  if ([g_uiwebview becomeFirstResponder])
  {
    CX_DEBUG_BREAK_ABLE;
    success = true;
  }
  */
  
  web_view_hide (false);
  /*
  static bool hidden = true;

  web_view_hide (hidden);
  
  hidden = !hidden;
  */
  return success;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void web_view_hide (bool hide)
{
#if 0
  g_uiwebview.hidden = hide;
#else

  if (!g_isAnimating)
  {
    [UIWebView animateWithDuration:0.5f 
                             delay:0.0f 
                           options:UIViewAnimationCurveEaseInOut|UIViewAnimationOptionTransitionNone
                        animations:^{ g_isAnimating = true; if (hide) { g_uiwebview.alpha = 0.0f; } else { g_uiwebview.alpha = 1.0f; g_uiwebview.hidden = NO; }; } 
                        completion:^(BOOL finished){ if (finished && hide) { g_uiwebview.hidden = YES; } g_isAnimating = false; }];
  }
#endif
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool web_view_is_shown (void)
{
  return (!g_isAnimating && !g_uiwebview.hidden);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
