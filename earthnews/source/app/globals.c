//
//  ui.c
//  earthnews
//
//  Created by Ubaka Onyechi on 09/04/2012.
//  Copyright (c) 2012 uonyechi.com. All rights reserved.
//

#include "globals.h"
#include "../engine/cx_engine.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static cx_font *s_font [NUM_APP_FONTS];

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void globals_create_fonts (void);
static void globals_destroy_fonts (void);

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool globals_init (void)
{
  globals_create_fonts ();
  
  return true;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void globals_deinit (void)
{
  globals_destroy_fonts ();
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

const cx_font *app_font_get_size (app_font_size_t fontsize)
{
  CX_ASSERT ((fontsize > APP_FONT_SIZE_INVALID) && (fontsize < NUM_APP_FONTS));
  
  return s_font [fontsize];
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void globals_render_fps (void)
{
  static float fps = 0.0f;
  static float totalTime = 0.0f;
  static unsigned int frameCount = 0;
  
  frameCount++;
  
  float deltaTime = (float) cx_system_time_get_delta_time ();
  
  //CX_DEBUGLOG_CONSOLE (1, "%.2f", deltaTime);
  
  totalTime += deltaTime;
  
  if (totalTime >= 1.0f)
  {
    fps = (float) frameCount / totalTime;
    frameCount = 0;
    totalTime = 0.0f;
  }
  
  fps = 1.0f/ deltaTime;
  
  char fpsStr [32];
  
  cx_sprintf (fpsStr, 32, "%.2f", fps);
  
  const cx_font *font = app_font_get_size (APP_FONT_SIZE_12); 
  
  float sw = 1024.0f;
  float sh = 768.0f;
  
  cx_font_render (font, fpsStr, (sw - 24.0f) - 2.0f, sh - 12.0f, 0.0f, CX_FONT_ALIGNMENT_DEFAULT, cx_colour_red ());
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool anim_begin (anim_t *anim, anim_type_t type, float duration, anim_finished_callback fn, void *fndata)
{
  CX_ASSERT (anim);
  
  bool ret = false;
  
  if (!anim->on)
  {
    anim->on = true;
    anim->duration = duration;
    anim->now = 0.0f;
    anim->t = 0.0f;
    anim->type = type;
    anim->fn = fn;
    anim->fndata = fndata;
    
    ret = true;
  }
  
  return ret;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool anim_update (anim_t *anim, float deltaTime)
{
  CX_ASSERT (anim);
  
  if (anim->on)
  {  
    anim->now += deltaTime;
    anim->t = anim->now / anim->duration;
    anim->t = cx_clamp (anim->t, 0.0f, 1.0f);
    
    if (anim->now > anim->duration)
    {
      if (anim->fn)
      {
        anim->fn (anim->fndata);
      }
      
      anim->on = false;
    }
    
    return true;
  }
  else
  {
    return false;
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void globals_create_fonts (void)
{
  const char *fontname = "data/fonts/verdana.ttf";
  
  s_font [APP_FONT_SIZE_10] = cx_font_create (fontname, 10.0f);
  s_font [APP_FONT_SIZE_12] = cx_font_create (fontname, 12.0f);
  s_font [APP_FONT_SIZE_14] = cx_font_create (fontname, 14.0f);
  s_font [APP_FONT_SIZE_18] = cx_font_create (fontname, 18.0f);
  s_font [APP_FONT_SIZE_20] = cx_font_create (fontname, 20.0f);
  s_font [APP_FONT_SIZE_24] = cx_font_create (fontname, 24.0f); 
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

static void globals_destroy_fonts (void)
{
  for (unsigned int i = 0; i < NUM_APP_FONTS; ++i)
  {
    cx_font_destroy (s_font [i]);
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

#if 0


static UIActivityIndicatorView *s_activityView = nil;
static int s_activityCount = 0;

static bool activity_indicator_init (void *rootvc)
{
  CX_ASSERT (rootvc);
  
  UIViewController *rootViewCtrlr = (UIViewController *) rootvc;
  
  s_activityView = [[UIActivityIndicatorView alloc] initWithActivityIndicatorStyle:UIActivityIndicatorViewStyleWhite];
  
  CGRect frame = s_activityView.frame;
  frame.origin.x = 8.0f;
  [s_activityView setFrame:frame];
  
  [rootViewCtrlr.view addSubview:s_activityView];
  
  return true;
}

static void activity_indicator_deinit (void)
{
  [s_activityView removeFromSuperview];
}

static void activity_indicator_set_active (bool active)
{
  if (active)
  {
    s_activityCount += 1;
    
    [s_activityView startAnimating];
  }
  else
  {
    CX_ASSERT (s_activityCount > 0);
    
    s_activityCount -= 1;
    
    if (s_activityCount <= 0)
    {
      [s_activityView stopAnimating];
    }
  }
}

static bool activity_indicator_get_active (void)
{
  return [s_activityView isAnimating];
}


#endif
