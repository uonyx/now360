//
//  cx_file.c
//
//  Created by Ubaka Onyechi on 02/01/2012.
//  Copyright (c) 2012 uonyechi.com. All rights reserved.
//

#include "cx_file.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

#define CX_FILE_DEBUG_LOG 1

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

extern void cx_native_get_filepath_from_resource (const char *filename, char *destFilepath, int destFilePathSize);

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool cx_file_load (cx_file *file, const char *filename)
{
  bool success = false;
  
  char fullFilePath [512];
  cx_native_get_filepath_from_resource (filename, fullFilePath, 512);
  
  file->size = 0;
  file->data = NULL;
  file->fp = fopen (fullFilePath, "rb");
  
  if (file->fp)
  {
    // get file size
    fseek (file->fp, 0L, SEEK_END);
    
    file->size = (cxu32) ftell (file->fp);
    
    fseek (file->fp, 0L, SEEK_SET);
    
    // get data
    file->data = (char *) cx_malloc (sizeof (char) * file->size + 1);
  
    if (file->data)
    {
      size_t bytesRead = fread (file->data, sizeof(char), file->size, file->fp);
      CX_ASSERT (bytesRead == file->size);
      CX_REFERENCE_UNUSED_VARIABLE (bytesRead);
      
      char *data = (char *) file->data;
      data [file->size] = 0;
      success = true;
    }
    else
    {
      CX_DEBUGLOG_CONSOLE (CX_FILE_DEBUG_LOG, "cx_file_load: failed to malloc %d bytes", (file->size * sizeof(char)));
    }
  }
  else
  {
    CX_DEBUGLOG_CONSOLE (CX_FILE_DEBUG_LOG, "cx_file_load: failed to open file [%s]", fullFilePath);
  }
  
  return success;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool cx_file_unload (cx_file *file)
{
  bool success = false;
  
  int err = fclose (file->fp);
  
  if (err == 0)
  {
    cx_free (file->data);
    
    file->size = 0;
    file->data = NULL;
    file->fp = NULL;
    
    success = true;
  }
  else
  {
    CX_DEBUGLOG_CONSOLE (CX_FILE_DEBUG_LOG, "cx_file_unload: failed to close file");
  }
  
  return success;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cxu32 cx_file_getsize (const char *filename)
{
  cxu32 size = 0;
  
  char fullFilePath [512];
  cx_native_get_filepath_from_resource (filename, fullFilePath, 512);
  
  FILE *fp = fopen (fullFilePath, "rb");
  
  if (fp)
  {
    // get file size
    fseek (fp, 0L, SEEK_END);
    
    size = (cxu32) ftell (fp);
    
    fseek (fp, 0L, SEEK_SET);
    
    fclose (fp);
  }
  else
  {
    CX_DEBUGLOG_CONSOLE (CX_FILE_DEBUG_LOG, "cx_file_getsize: failed to open file [%s]", fullFilePath);
  }
  
  return size;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool cx_file_getexists (const char *filename)
{
  FILE *fp = fopen (filename, "rb");
  
  if (fp)
  {
    fclose (fp);
    return true;
  }
  else
  {
    return false;
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

