//
//  cx_data.c
//
//  Created by Ubaka Onyechi on 17/02/2013.
//  Copyright (c) 2013 uonyechi.com. All rights reserved.
//

#include "cx_data.h"
#include "cx_file.h"

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

#define CX_DATA_DEBUG_LOG_ENABLED 1

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_data *cx_data_create (cxu32 size)
{
  //cx_data *data = cx_malloc ((size * sizeof (cxu8)) + (sizeof (cxu32)));
  //data->bytes = (cxu8 *) data;
  
  cx_data *data = cx_malloc (sizeof (cx_data));
  data->bytes = cx_malloc (sizeof (cxu8) * size);
  data->size = size;
  
  return data;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_data *cx_data_create_from_file (const char *filename)
{
  CX_ASSERT (filename);
  
  cx_data *data = NULL;
  
  cx_file file;
  
  if (cx_file_open (&file, filename, CX_FILE_MODE_READ))
  {
    cxu32 size = cx_file_size (&file);
    
    data = cx_data_create (size + 1);
    
    if (data)
    {
      cxu32 read = cx_file_read (&file, data->bytes, sizeof (cxu8), size);
      
      CX_ASSERT (read == size);
      CX_REFERENCE_UNUSED_VARIABLE (read);
      
      data->bytes [size] = 0;
      
      cx_file_close (&file);
      
      return data;
    }
  }
  
  CX_DEBUGLOG_CONSOLE (CX_DATA_DEBUG_LOG_ENABLED, "cx_data_create_from_file: failed to open file [%s]", filename);
  
  return data;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

bool cx_data_save_to_file (cx_data *data, const char *filename)
{
  CX_ASSERT (filename);
  
  cx_file file;
  
  if (cx_file_open (&file, filename, CX_FILE_MODE_WRITE))
  {
    cxu32 written = cx_file_write (&file, data->bytes, sizeof (cxu8), data->size);
    
    CX_ASSERT (written == data->size);
    CX_REFERENCE_UNUSED_VARIABLE (written);
    
    cx_file_close (&file);
    
    return true;
  }
  
  return false;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void cx_data_destroy (cx_data *data)
{
  CX_ASSERT (data);
  
  cx_free (data->bytes);
  cx_free (data);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
