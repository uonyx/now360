//
//  cx_xml.c
//
//  Created by Ubaka Onyechi on 28/07/2012.
//  Copyright (c) 2012 uonyechi.com. All rights reserved.
//

#include "cx_xml.h"
#include "cx_file.h"
#include <libxml/parser.h>
#include <libxml/tree.h>

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_doc cx_xml_doc_create (const char *data, cxu32 dataSize)
{
  //xmlDocPtr xmlDoc = xmlReadMemory (data, dataSize, "noname.xml", NULL, 0);
  
  xmlDocPtr xmlDoc = xmlParseMemory (data, dataSize);
  
  return xmlDoc;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

void cx_xml_doc_destroy (cx_xml_doc doc)
{
  CX_ASSERT (doc);
  
  xmlDocPtr xmlDoc = (xmlDocPtr) (doc);
  
  xmlFreeDoc (xmlDoc);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_node cx_xml_doc_root_node (cx_xml_doc doc)
{
  CX_ASSERT (doc);
  
  xmlNodePtr rootNode = xmlDocGetRootElement (doc);
  
  return rootNode;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_node cx_xml_node_child (cx_xml_node node, const char *name, const char *nsprefix)
{
  CX_ASSERT (node);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  xmlNode *child = xmlnode->children;
  
  const xmlChar *xmlname = (const xmlChar *) name;
  
  while (child)
  {
    const char *cn = (const char *) child->name;
    (void) cn;
    
    if (xmlStrcmp (child->name, xmlname) == 0)
    {
      if (nsprefix)
      {
        if (child->ns && (xmlStrcmp (child->ns->prefix, (const xmlChar *) nsprefix)) == 0)
        {
          break;
        }
      }
      else
      {
        break;
      }
    }
    
    child = child->next;
  }
  
  return child;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_node cx_xml_node_first_child (cx_xml_node node)
{
  CX_ASSERT (node);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  xmlNode *firstChild = xmlnode->children;
  
  return firstChild;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_node cx_xml_node_last_child (cx_xml_node node)
{
  CX_ASSERT (node);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  xmlNode *lastChild = xmlnode->last;
  
  return lastChild;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_node cx_xml_node_next_sibling (cx_xml_node node)
{
  CX_ASSERT (node);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  xmlNodePtr nextnode = xmlnode->next;
  
  return nextnode;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_node cx_xml_node_parent (cx_xml_node node)
{
  CX_ASSERT (node);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  xmlNodePtr parentnode = xmlnode->parent;
  
  return parentnode;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

const char *cx_xml_node_name (cx_xml_node node)
{
  CX_ASSERT (node);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  return (const char *) xmlnode->name;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

char *cx_xml_node_content (cx_xml_node node)
{
  CX_ASSERT (node);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  char *content = (char *) xmlNodeGetContent (xmlnode);
  
  // free
  
  return content;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

char *cx_xml_node_attr (cx_xml_node node, const char *name)
{
  CX_ASSERT (node);
  CX_ASSERT (name);
  
  xmlNodePtr xmlnode = (xmlNodePtr) node;
  
  const xmlChar *xmlname = (const xmlChar *) name;
  
  char *content = (char *) xmlGetProp (xmlnode, xmlname);
  
  // free
  
  return content;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

cx_xml_attr cx_xml_attr_get_next_sibling (cx_xml_attr attr)
{
  return NULL;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

const char *cx_xml_attr_get_name (cx_xml_attr attr)
{
  CX_ASSERT (attr);
  
  xmlAttributePtr xmlattr = (xmlAttributePtr) attr;
  
  return (const char *) xmlattr->name;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
